#!/usr/bin/env node
import { Command } from 'commander';
import T from 'node:fs/promises';
import E from 'node:path';
import Ue from 'ora';
import He from 'yaml';
import { execa } from 'execa';
import De from 'node:os';
import ht from 'node:dns/promises';
import Fe from 'prompts';
import pe, { randomUUID } from 'node:crypto';
import { createRequire } from 'node:module';
import { promisify } from 'node:util';
import F from 'node:fs';
import { fileURLToPath } from 'node:url';
import N from 'semver';
import ge from 'chalk';
import { Buffer as Buffer$1 } from 'node:buffer';

var O=class extends Error{constructor(e,t="HBX_ERROR",n){super(e),this.name="HbxError",this.code=t,this.details=n;}},d=class extends O{constructor(e,t){super(e,"HBX_INPUT_ERROR",t);}},Z=class extends O{constructor(e="Operation cancelled by user"){super(e,"HBX_ABORTED");}},he=class extends O{constructor(e,t){super(e,"HBX_CONFIG_ERROR",t);}};function ot(r){return !!(r&&typeof r=="object"&&"code"in r)}async function v(r){try{return await T.access(r),!0}catch{return  false}}async function $(r){await T.mkdir(r,{recursive:true});}async function we(r){if(!await v(r)){await $(r);return}if((await T.readdir(r)).length>0)throw new Error(`Directory ${r} is not empty`)}async function j(r,e){await $(E.dirname(r)),await T.writeFile(r,e);}var ve="hbx",G="HBX_DEBUG",ee="HBX_LICENSE_TOKEN",st="HBX_TELEMETRY_DISABLED",Oe=E.join(De.homedir(),".hbx"),xe=E.join(Oe,"config.json"),br=E.join(De.homedir(),".cache","hbx"),te=E.join(br,"templates"),at="HBX_UPDATE_CHECK_DISABLED",re="https://api.github.com",ct=`${re}/repos/HugoBlox/hugo-blox-builder/contents/templates`,lt="https://github.com/HugoBlox/hugo-blox-builder.git",mt="HBX_TEMPLATES_DIR",X="https://cli-api.hugoblox.com",ut=`${X}/api/usage-insights`,Ce="hugoblox",dt=1e3*60*60*24,pt=1e3*60*60*12;var Me=[{id:"academic-cv",name:"Academic CV",description:"Publish your academic CV and showcase your research.",repoPath:"templates/academic-cv",slug:"academic-cv",tags:["academic","cv"],source:"oss"},{id:"startup",name:"Startup",description:"Marketing site for SaaS and startups.",repoPath:"templates/startup",slug:"startup",tags:["business"],source:"oss"},{id:"folio",name:"Portfolio",description:"Minimal portfolio for creatives.",repoPath:"templates/folio",slug:"folio",tags:["portfolio"],source:"oss"}];var Pe="hbx.blocks.json";async function D(r=process.cwd()){let e=r,{root:t}=E.parse(r);for(;;){if((await Promise.all([v(E.join(e,"config","_default")),v(E.join(e,"hugoblox.yaml"))])).some(Boolean))return {root:e,manifestPath:E.join(e,Pe)};if(e===t)return;e=E.dirname(e);}}async function ft(r){let e=E.join(r,"hugoblox.yaml");if(await v(e))try{let t=await T.readFile(e,"utf8"),n=He.parse(t);if(!n)return;let o=n.template??{},i=n.build??{};return {templateId:o.id,templateName:o.name,requiredHugoVersion:i.hugo_version}}catch(t){throw new d("Failed to parse hugoblox.yaml",{error:t})}}async function gt(){try{let{stdout:r}=await execa("hugo",["version"]);return Pr(r)}catch{return}}function Pr(r){let e=r.match(/v(\d+\.\d+\.\d+)/i);return e?e[1]:r.match(/(\d+\.\d+\.\d+)/)?.[1]}var J=class extends Error{constructor(t,n){super(t);this.cause=n;this.name="NetworkError";}};async function oe(r,e={}){let{timeout:t=15e3,retries:n=3,backoff:o=500,...i}=e,s=0;for(;s<=n;){let c=new AbortController,a=setTimeout(()=>c.abort(),t);try{let l=await fetch(r,{...i,signal:c.signal});if(clearTimeout(a),l.status===429||l.status>=500&&l.status<600)throw new J(`Server error: ${l.status}`);return l}catch(l){clearTimeout(a),s++;let m=l.name==="AbortError";if(s>n)throw m?new J(`Request timed out after ${t}ms`,l):l instanceof J?l:new J("Network request failed",l);let b=o*2**(s-1);await new Promise(u=>setTimeout(u,b));}}throw new J("Unreachable")}async function yt(){try{return await ht.lookup("google.com"),!0}catch{try{return await ht.lookup("1.1.1.1"),!0}catch{return  false}}}async function B(r,e={}){if(e.ci){if(typeof e.initial=="string")return e.initial;throw new d(`Option required in CI mode: ${r}`)}return (await Fe({type:"text",name:"value",message:r,initial:e.initial},{onCancel:()=>{throw new Z}})).value}async function de(r,e,t={}){if(t.ci){if(typeof t.initial=="string")return t.initial;throw new d(`Option required in CI mode: ${r}`)}return (await Fe({type:"select",name:"value",message:r,choices:e,initial:0},{onCancel:()=>{throw new Z}})).value}async function R(r,e={}){if(e.ci){if(typeof e.initial=="boolean")return e.initial;throw new d(`Confirmation required in CI mode: ${r}`)}return (await Fe({type:"confirm",name:"value",message:r,initial:e.initial??true},{onCancel:()=>{throw new Z}})).value}function vt(r){let e=r.match(/github\.com[/:]([\w-]+)\/([\w-]+?)(?:\.git)?$/i);return e?{owner:e[1],repo:e[2]}:null}function Sr(r){return vt(r)!==null}async function kr(r,e){let t=`https://api.github.com/repos/${r}/${e}/contents/hugoblox/themes`;try{let n=await oe(t,{headers:{"User-Agent":"hbx-cli",Accept:"application/vnd.github.v3+json"}});if(!n.ok)throw n.status===404?new d(`Repository does not contain a 'hugoblox/themes' directory. Please check the repository structure at https://github.com/${r}/${e}`):new d(`Failed to fetch themes from GitHub (status ${n.status})`);let i=(await n.json()).filter(s=>s.type==="file"&&s.name.toLowerCase().endsWith(".yaml"));if(i.length===0)throw new d(`No theme files found in hugoblox/themes directory at https://github.com/${r}/${e}`);return i.map(s=>({name:s.name,downloadUrl:s.download_url}))}catch(n){throw n instanceof d?n:new d(`Failed to access GitHub repository: ${n instanceof Error?n.message:String(n)}`)}}async function Er(r,e){let t=await oe(r,{headers:{"User-Agent":"hbx-cli"}});if(!t.ok)throw new d(`Failed to download theme file (status ${t.status})`);let n=await t.text();await j(e,n);}async function Tr(r,e){let t=E.join(r,"config","_default","params.yaml");if(!await v(t))throw new d(`params.yaml not found at ${t}. Please ensure you're in a HugoBlox site.`);let n=await T.readFile(t,"utf8"),o=He.parse(n),i=typeof o=="object"&&o!==null?o:{};(typeof i.hugoblox!="object"||i.hugoblox===null)&&(i.hugoblox={});let s=i.hugoblox;(typeof s.theme!="object"||s.theme===null)&&(s.theme={}),s.theme.pack=e;let c=He.stringify(i);await T.writeFile(t,c,"utf8");}function U(r){return r.toLowerCase().replace(/\.yaml$/i,"")}function xt(r,e){r.command("theme").description("Add theme pack(s) from a GitHub repository").option("--repo <url>","GitHub repository URL containing themes").option("--theme <name>","Specific theme filename to download (without .yaml), or 'all' for all themes").option("--set-active","Set the downloaded theme as active in params.yaml").option("--no-set-active","Skip setting theme as active").option("--ci","Run in non-interactive mode").action(async(t,n)=>{let{logger:o,telemetry:i}=e,s=!!n.optsWithGlobals().json;try{let c=await D();if(!c)throw new d("Not in a HugoBlox site. Please run this command from within a HugoBlox site directory (must contain hugoblox.yaml)");let a=c.root,l=t.repo;if(!l){if(t.ci)throw new d("--repo is required when running with --ci");l=await B("Enter the GitHub repository URL containing themes (e.g., https://github.com/username/themes-repo):");}if(l=l.trim(),!Sr(l))throw new d("Invalid GitHub repository URL. Please provide a valid GitHub URL (e.g., https://github.com/owner/repo)");let m=vt(l);if(!m)throw new d("Failed to parse GitHub URL");let{owner:f,repo:b}=m,u=f,p=Ue("Fetching available themes...").start(),h;try{h=await kr(f,b),p.succeed(`Found ${h.length} theme(s)`);}catch(S){throw p.fail("Failed to fetch themes"),S}let g,w=t.theme;if(!w)if(t.ci)w="all";else {let S=[{title:"All themes",value:"all"},...h.map(A=>({title:U(A.name),value:A.name}))];w=await de("Which theme(s) do you want to download?",S);}if(w.toLowerCase()==="all")g=h;else {let S=U(w),k=h.find(A=>U(A.name)===S);if(!k)throw new d(`Theme '${w}' not found. Available themes: ${h.map(A=>A.name).join(", ")}`);g=[k];}let P=E.join(a,"data","themes",u);await $(P);let x=Ue(`Downloading ${g.length} theme(s)...`).start();try{for(let S of g){let k=E.join(P,S.name);await Er(S.downloadUrl,k);}x.succeed(`\u2705 Downloaded ${g.length} theme(s) to data/themes/${u}/`);}catch(S){throw x.fail("Failed to download themes"),S}let C=!1,H=null;if((t.setActive||t.setActive!==!1&&!t.noSetActive)&&(t.ci?g.length===1&&(C=!0,H=U(g[0].name)):(C=await R("Do you want to set one of these themes as active?",{initial:g.length===1}),C&&(g.length===1?H=U(g[0].name):H=await de("Which theme do you want to activate?",g.map(k=>({title:U(k.name),value:U(k.name)})))))),C&&H){let S=`${u}/${H}`,k=Ue("Updating params.yaml...").start();try{await Tr(a,S),k.succeed(`\u2705 Set active theme to: ${S}`);}catch(A){throw k.fail("Failed to update params.yaml"),A}}if(await i.track({name:"add-theme",payload:{vendor:u,themesCount:g.length,activated:C,ci:!!t.ci}}),s){o.json({status:"success",vendor:u,themes:g.map(S=>S.name),activated:H?`${u}/${H}`:null});return}o.success(`
\u{1F3A8} Themes installed successfully!`),(!C||!H)&&(o.info(`
\u{1F4DD} To use a theme, update your config/_default/params.yaml:`),o.info(`
hugoblox:`),o.info("  theme:"),o.info(`    pack: "${u}/${U(g[0].name)}"`));}catch(c){if(s){o.json({status:"error",message:c instanceof Error?c.message:String(c)});return}throw c}});}function Ct(r,e){let t=r.command("add").description("Add resources (themes)");xt(t,e);}function Pt(r,e){r.command("block").argument("<id>","Block identifier").description("Create a new HugoBlox block").option("--example <slug>","Include sample content for the block").option("--dry-run","Print the actions without writing files").option("--yes","Overwrite files when they already exist").action((t,n,o)=>{let{logger:i}=e,s=!!o.optsWithGlobals().json,c="Block creation is coming soon. Follow Discord for updates or to preview it early.";if(s){i.json({status:"pending",message:c});return}i.info(c);});}var We="com.hugoblox.cli",$r=1,_r=createRequire(import.meta.url),Hr=promisify(pe.scrypt),M=null;try{M=_r("keytar");}catch{M=null;}async function St(r,e,t,n,o){let i=`device:${t}`,s,c;if(M)await M.setPassword(We,i,n);else {let a=await Dr(n,e);s=a.payload,c=a.salt;}r.setDeviceInfo({id:t,label:o,secretAlias:M?i:void 0,secretFallback:s,secretFallbackSalt:c,secretFallbackVersion:s?$r:void 0}),await r.save();}async function kt(r,e){let t=r.getDeviceInfo();if(!t?.id)return;let n;if(t.secretAlias&&M&&(n=await M.getPassword(We,t.secretAlias)),!n&&t.secretFallback&&t.secretFallbackSalt)try{let{key:o}=await Et(e,t.secretFallbackSalt);n=Rr(t.secretFallback,o);}catch{n=void 0;}if(n)return {id:t.id,secret:n,label:t.label}}async function ze(r){let e=r.getDeviceInfo();e?.secretAlias&&M&&await M.deletePassword(We,e.secretAlias),r.setDeviceInfo(void 0),await r.save();}function jr(r,e){let t=pe.randomBytes(12),n=pe.createCipheriv("aes-256-gcm",e.subarray(0,32),t),o=Buffer.concat([n.update(r,"utf8"),n.final()]),i=n.getAuthTag();return Buffer.concat([t,i,o]).toString("base64")}function Rr(r,e){let t=Buffer.from(r,"base64"),n=t.subarray(0,12),o=t.subarray(12,28),i=t.subarray(28),s=pe.createDecipheriv("aes-256-gcm",e.subarray(0,32),n);return s.setAuthTag(o),Buffer.concat([s.update(i),s.final()]).toString("utf8")}async function Et(r,e){let t=Buffer.from(e,"base64");return {key:await Hr(r,t,32,{N:32768,r:8,p:1,maxmem:64*1024*1024}),salt:e}}async function Dr(r,e){let t=pe.randomBytes(16).toString("base64"),{key:n}=await Et(e,t);return {payload:jr(r,n),salt:t}}async function L(r,e={}){let t=r.config.getLicense();if(!t)throw new d("Set HBX_LICENSE_TOKEN or run 'hbx login' to access Pro content.");let n=await r.config.ensureTelemetryId();if(e.force)await ze(r.config);else {let s=await kt(r.config,n);if(s)return {id:s.id,secret:s.secret}}let o=e.label??De.hostname(),i=await Lr(r.config,t,n,o);return await St(r.config,n,i.deviceId,i.deviceSecret,o),r.logger.debug(`Registered device ${i.deviceId}`),{id:i.deviceId,secret:i.deviceSecret}}async function Tt(r){await ze(r);}async function Lr(r,e,t,n){let o=await fetch(`${X}/api/license/devices/register`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","x-telemetry-id":t},body:JSON.stringify({deviceLabel:n})}),i=await Nr(o);if(!o.ok)throw i?.code==="license_device_limit"?new d("This license has reached the maximum number of devices. Revoke an existing device and try again."):o.status===401||o.status===403?new d(i?.error??"Unable to register device"):new d(i?.error??`Device registration failed (status ${o.status})`);if(!i?.deviceId||!i?.deviceSecret)throw new d("Device registration response was missing credentials");return i}async function Nr(r){try{return await r.json()}catch{return}}function Or(r){return r.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}async function V(r){let{logger:e}=r,t=await Mr(e),n=await Fr(r);return t.length||n.length?[...n,...t]:Me}async function Mr(r){try{let e=await fetch(ct,{headers:{"User-Agent":"hbx-cli"}});if(!e.ok)throw new Error(`GitHub responded with status ${e.status}`);return (await e.json()).filter(o=>o.type==="dir").map(o=>({id:o.name,name:Or(o.name),description:`Starter template ${o.name}`,repoPath:o.path,slug:o.name,source:"oss"}))}catch(e){return r?.debug?.(`Falling back to offline starter metadata: ${String(e)}`),Me}}async function Fr(r){let{logger:e,config:t}=r,n=new Headers({"User-Agent":"hbx-cli"});try{let c=await t.ensureTelemetryId();n.set("x-telemetry-id",c);}catch{}let o,i=t.getLicense();if(i)try{let c=await L(r);o=new Headers(n),o.set("Authorization",`Bearer ${i}`),o.set("X-HBX-Device-Id",c.id),o.set("X-HBX-Device-Secret",c.secret);}catch(c){e?.debug?.(`Skipping device-auth headers for Pro templates: ${String(c)}`);}let s=[];o&&s.push({label:"with auth",headers:o}),s.push({label:o?"without auth":"anonymous",headers:n});for(let c of s)try{let a=await fetch(`${X}/api/pro-templates`,{headers:c.headers});if(!a.ok)throw new Error(`catalog responded with status ${a.status}`);return (await a.json()).templates.map(m=>({id:m.id,name:`${m.name} (Pro)`,description:m.description??void 0,repoPath:void 0,slug:m.slug??m.id,source:"pro",version:m.version,sizeBytes:m.sizeBytes,updatedAt:m.updatedAt,commitHash:m.commitHash,downloadEndpoint:m.downloadUrl}))}catch(a){e.debug(`Unable to fetch Pro template catalog (${c.label}): ${String(a)}`);}return []}async function Se(r,e){try{await execa("git",["init"],{cwd:r}),await execa("git",["add","."],{cwd:r}),await execa("git",["commit","-m","chore: initialize site"],{cwd:r,reject:!1}),e.success(`Initialized git repository in ${E.relative(process.cwd(),r)||"."}`);}catch(t){e.warn(`Git initialization skipped: ${String(t)}`);}}async function Xe(r,e,t={},n=0){let o=r.config.getLicense();if(!o)throw new d("A HugoBlox Pro license key is required before accessing Pro templates.");let i=await r.config.ensureTelemetryId(),s=await L(r,{force:n>0}),c=new Headers(t.headers??{});c.set("Authorization",`Bearer ${o}`),c.set("X-HBX-Device-Id",s.id),c.set("X-HBX-Device-Secret",s.secret),c.set("X-Telemetry-Id",i);let a=await fetch(`${X}${e}`,{...t,headers:c});if((a.status===401||a.status===403)&&n===0)return await L(r,{force:true}),Xe(r,e,t,n+1);if(!a.ok){let l=await Vr(a);throw l?.code==="license_device_limit"?new d("This license has reached the maximum number of devices. Revoke an existing device and try again."):a.status===401||a.status===403?new d(l?.error??"Device authentication failed."):new d(l?.error??`Request failed (${a.status})`)}return a}async function Vr(r){try{return await r.json()}catch{return}}var Wr=3;async function $t(r,e,t,n){if(e.source==="pro"){await Jr(r,e,t,n);return}let o=process.env[mt];if(o){await zr(e,o,t),n.debug(`Hydrated template ${e.id} from local override`);return}let i=await Xr(e,n),s=i!==void 0?E.join(te,e.id,i):void 0;if(s&&await v(s)){await q(s,t),n.debug(`Hydrated template ${e.id} from cache (${i})`);return}let c=await T.mkdtemp(E.join(De.tmpdir(),"hbx-template-")),a=E.join(c,"repo");try{await execa("git",["clone","--depth","1",lt,a],{stdio:"ignore"});let l=await Gr(a,e);s?(await $(E.dirname(s)),await T.rm(s,{recursive:!0,force:!0}),await T.cp(l,s,{recursive:!0}),await _t(E.join(te,e.id)),await q(s,t),n.debug(`Hydrated template ${e.id} from fresh cache (${i})`)):(await q(l,t),n.debug(`Hydrated template ${e.id} from repository`));}catch(l){throw new d("Failed to clone HugoBlox templates. Ensure git is installed and accessible.",{error:l})}finally{await T.rm(c,{recursive:true,force:true});}}async function zr(r,e,t){let n=E.join(e,r.id);try{await T.access(n);}catch(o){throw new d(`Local template not found at ${n}`,{error:o})}await q(n,t);}async function Gr(r,e){let t=e.repoPath??"",n=E.join(r,t);return await T.access(n),n}async function q(r,e){await T.rm(e,{recursive:true,force:true}),await $(E.dirname(e)),await T.cp(r,e,{recursive:true}),await T.rm(E.join(e,".git"),{recursive:true,force:true});}async function _t(r){if(!await v(r))return;let e=await T.readdir(r,{withFileTypes:true}),t=await Promise.all(e.filter(n=>n.isDirectory()).map(async n=>{let o=E.join(r,n.name),i=await T.stat(o);return {path:o,mtimeMs:i.mtimeMs}}));t.sort((n,o)=>o.mtimeMs-n.mtimeMs);for(let n of t.slice(Wr))await T.rm(n.path,{recursive:true,force:true});}async function Xr(r,e){let t=encodeURIComponent(r.repoPath??""),n=`${re}/repos/HugoBlox/hugo-blox-builder/commits?path=${t}&per_page=1`;try{let o=await fetch(n,{headers:{"User-Agent":"hbx-cli"}});if(!o.ok)throw new Error(`GitHub responded with status ${o.status}`);return (await o.json())[0]?.sha}catch(o){e.debug(`Unable to determine latest template commit for ${r.id}: ${String(o)}`);return}}async function Jr(r,e,t,n){let o=e.version?E.join(te,e.id,e.version):void 0;if(o&&await v(o)){await q(o,t),n.debug(`Hydrated Pro template ${e.id} from cache (${e.version})`);return}let i=await T.mkdtemp(E.join(De.tmpdir(),"hbx-pro-template-")),s=E.join(i,"template.tgz"),c=E.join(i,"extract");await $(c);try{let a=await qr(r,e,s);await execa("tar",["-xzf",s,"-C",c]);let l=await Kr(c,e.slug),m=e.version??a.version??void 0,f=m!==void 0?E.join(te,e.id,m):void 0;f?(await $(E.dirname(f)),await T.rm(f,{recursive:!0,force:!0}),await T.cp(l,f,{recursive:!0}),await _t(E.join(te,e.id)),await q(f,t),n.debug(`Hydrated Pro template ${e.id} from fresh cache (${m})`)):(await q(l,t),n.debug(`Hydrated Pro template ${e.id} from archive`));}catch(a){throw new d(`Failed to download Pro template ${e.name}. Ensure your license is valid and try again.`,{error:a})}finally{await T.rm(i,{recursive:true,force:true});}}async function qr(r,e,t){let n=e.downloadEndpoint??`/api/pro-templates/${encodeURIComponent(e.id)}/download`,o=await Xe(r,n),i=await Yr(o);if(!i?.url)throw new d("Pro template download URL was missing");let s=await fetch(i.url);if(!s.ok)throw new d(`Pro template archive download failed (${s.status})`);let c=Buffer.from(await s.arrayBuffer());return await T.writeFile(t,c),{version:i.version}}async function Kr(r,e){let t=await T.readdir(r,{withFileTypes:true}),n=t.find(i=>i.isDirectory()&&i.name===e);if(n)return E.join(r,n.name);let o=t.filter(i=>i.isDirectory());return o.length===1?E.join(r,o[0].name):r}async function Yr(r){try{return await r.json()}catch{return}}var Ht="https://hugoblox.com/discord",jt="https://docs.hugoblox.com",Rt="https://hugoblox.com/pro";function z(r){return r.trim().toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)}async function ke(r,e,t,n){let{logger:o}=r;await $t(r,t,e,o),await Zr(e,t,n),n.sampleContent||await tn(e,t);}async function Ee(r,e,t){t.info(`\u{1F4E6} Installing dependencies with ${e}...`);let n={...process.env},o=["install"],i=!t.isJsonMode();e==="pnpm"&&(n.PNPM_WORKSPACE_DIR=r,n.PNPM_IGNORE_WORKSPACE_ROOT_CHECK="1",await Qr(r),o.push("--no-link-workspace-packages"));try{return await execa(e,o,{cwd:r,stdio:i?"ignore":"inherit",env:n}),t.success("\u2705 Dependencies installed"),!0}catch(s){return i?t.warn(`\u26A0\uFE0F  Failed to install dependencies automatically. Run ${e} install inside ${r}`):t.warn(`\u26A0\uFE0F  Failed to install dependencies automatically: ${String(s)}`),false}}async function Qr(r){let e=E.join(r,"pnpm-workspace.yaml");if(await v(e))return;await j(e,`packages:
  - './*'
`);}async function Lt(r,e,t){t.info("\u{1F525} Starting dev server with Hugo (press Ctrl+C to exit)...");let n={...process.env};e==="pnpm"&&(n.PNPM_WORKSPACE_DIR=r);try{await execa(e,["dev"],{cwd:r,stdio:"inherit",env:n}),t.success("\u2705 Dev server stopped");}catch(o){let i=o;if(i.signal==="SIGINT"||i.signal==="SIGTERM"){t.info("\u2705 Dev server stopped");return}if(o?.code==="ENOENT"||/[hH]ugo/.test(String(i.stderr))){t.error("Hugo executable not found. Install Hugo (https://docs.hugoblox.com/start/cli) or deploy with the Copilot at https://hugoblox.com/templates/");return}throw t.error(`Dev server exited with an error: ${String(o)}`),o}}async function Zr(r,e,t){let n=z(E.basename(r))||e.slug;await en(r,n);let o={"README.md":`# ${e.name}

This site was created with the HugoBlox CLI.
`,".gitignore":`node_modules
.cache
.env
public
.DS_Store
modules/_vendor
`};t.includeEnv&&(o[".env"]=`# HBX environment variables
HBX_LICENSE_TOKEN=
`);for(let[i,s]of Object.entries(o)){let c=E.join(r,i);await v(c)||await j(c,s);}}async function en(r,e){let t=E.join(r,"package.json"),n={name:e,private:true,scripts:{dev:"hugo server -D",build:"hugo --gc --minify",lint:"echo 'TODO: add lint script'"},dependencies:{}};if(!await v(t)){await j(t,JSON.stringify(n,null,2));return}try{let o=await T.readFile(t,"utf8"),i=JSON.parse(o),s={...n,...i,name:e,scripts:{...n.scripts,...i.scripts},dependencies:{...n.dependencies,...i.dependencies}};await j(t,JSON.stringify(s,null,2));}catch{await j(t,JSON.stringify(n,null,2));}}async function tn(r,e){let t=E.join(r,"content");await T.rm(t,{recursive:true,force:true}),await $(E.dirname(E.join(t,"_index.md"))),await j(E.join(t,"_index.md"),rn(e));}function rn(r){return `---
title: "${r.name}"
type: landing
design:
  spacing: "5rem"

sections:
  - block: hero
    content:
      eyebrow: "You're live on HugoBlox"
      title: "Great job launching ${r.name}"
      text: "Start customizing blocks to launch your next experience."
      primary_action:
        text: "Join our Discord"
        url: "${Ht}"
        icon: "chat-bubble-left-right"
      secondary_action:
        text: "Upgrade to Pro"
        url: "${Rt}"
      tertiary_action:
        text: "View Docs"
        url: "${jt}"
    design:
      css_class: "bg-gradient-to-r from-blue-600 to-indigo-600 text-white"
      spacing:
        padding: ["4rem", 0, "4rem", 0]
  - block: markdown
    content:
      title: "Your next steps"
      text: |
        1. Join the community on [Discord](${Ht}) for support and inspiration.
        2. Explore the [documentation](${jt}) to learn how to add blocks, deploy, and automate.
        3. [Upgrade to Pro](${Rt}) to unlock premium blocks, design systems, and automation-ready packages.
        4. Share feedback and showcase your build to help the ecosystem grow.
`}function Je(r){return r?r.length<=6?"***":`${r.slice(0,3)}***${r.slice(-2)}`:"(none)"}function Te(r,e){let t=r??e;return E.resolve(process.cwd(),t)}async function Nt(r=process.cwd()){let e=E.join(r,"pnpm-lock.yaml"),t=E.join(r,"yarn.lock"),n=E.join(r,"package-lock.json");return F.existsSync(e)?"pnpm":F.existsSync(t)?"yarn":F.existsSync(n)?"npm":"pnpm"}async function Ae(r){try{let e=E.resolve(r);if(r.includes("\0")||/[<>:"|?*]/.test(r))return {valid:!1,exists:!1,isEmpty:!1,writable:!1,error:"Path contains invalid characters"};let t=!1,n=!1,o=!1;try{let i=F.statSync(e);if(t=!0,i.isDirectory()){n=F.readdirSync(e).length===0;try{F.accessSync(e,F.constants.W_OK),o=!0;}catch{o=!1;}}else return {valid:!1,exists:!0,isEmpty:!1,writable:!1,error:"Path exists but is not a directory"}}catch{let s=E.dirname(e);try{F.accessSync(s,F.constants.W_OK),o=!0;}catch{return {valid:!1,exists:!1,isEmpty:!1,writable:!1,error:"Parent directory is not writable"}}}return {valid:!0,exists:t,isEmpty:n,writable:o}}catch(e){return {valid:false,exists:false,isEmpty:false,writable:false,error:e instanceof Error?e.message:"Unknown error"}}}function nn(r,e){if(!e)return;let t=e.toLowerCase(),n=r.find(o=>{let i=o.id.toLowerCase(),s=o.slug?.toLowerCase();return i===t||s===t});if(n)return n;if(e.startsWith("http")||e.startsWith("git@"))return {id:e,name:"Custom template",description:`External template: ${e}`,repoPath:e,slug:"custom",source:"custom"}}function Ft(r,e){r.command("site").description("Create a new HugoBlox site").argument("[dir]","Target directory (defaults to template slug, e.g., new-site)").option("--template <id>","Starter template ID").option("--dir <path>","Target directory").option("--package-manager <name>","Package manager","pnpm").option("--no-install","Skip dependency installation").option("--git","Initialize a git repository").option("--ci","Run in non-interactive mode").option("--sample-content","Force include sample content").option("--no-sample-content","Skip sample content").option("--pro","Mark the project as Pro ready").option("--preview","Automatically start the dev server after setup").option("--no-preview","Skip the dev server prompt").action(async(t,n,o)=>{let{logger:i,config:s,telemetry:c}=e,l=!!o.optsWithGlobals().json,m=Ue({text:"Fetching templates...",spinner:"dots"}).start(),f=await V(e).finally(()=>{m.succeed("\u2728 Templates ready");}),u=nn(f,n.template);if(!u){if(n.ci)throw new d("Template must be specified when running with --ci");let k=await de("Select a starter",f.map(A=>({title:A.name,description:A.description,value:A.id})));u=f.find(A=>A.id===k);}if(!u)throw new d("Unable to determine template");let p=u.source==="pro",h=await sn(n,t,u),g=Te(h,u.slug);await we(g);let w=typeof n.sampleContent=="boolean"?n.sampleContent:typeof n.noSampleContent=="boolean"?!n.noSampleContent:n.ci?false:await R("Include sample content? (recommended)",{initial:true}),P=p;if(!p)P=typeof n.pro=="boolean"?n.pro:n.ci?false:await R("Do you have a HugoBlox Pro license?",{initial:!!s.getLicense()});else if(!s.getLicense()){if(n.ci)throw new d(`"${u.name}" is a HugoBlox Pro template. Set HBX_LICENSE_TOKEN with your license key before running in CI.`);if(i.info(`"${u.name}" is part of HugoBlox Pro. Purchase a license at https://hugoblox.com/pro to receive your key via email (powered by Lemon Squeezy).`),!await R("Do you have a HugoBlox Pro license key to enter now?",{initial:true}))throw new d("Pro templates require an active license. Purchase at https://hugoblox.com/pro and rerun this command after running 'hbx login' or setting HBX_LICENSE_TOKEN.");let A=await Mt(s.getLicense());s.setLicense(A),await s.save();}if(!p&&P&&!s.getLicense()){if(n.ci)throw new d("Set HBX_LICENSE_TOKEN before running --ci when enabling Pro features.");let k=await Mt(s.getLicense());s.setLicense(k),await s.save();}P&&await L(e);let x=Ue(`Creating site in ${E.relative(process.cwd(),g)||"."}...`).start();try{await ke(e,g,u,{sampleContent:w,includeEnv:!0,packageManager:n.packageManager??"pnpm"}),x.succeed("Files generated");}catch(k){throw x.fail("Failed to scaffold site"),k}let C=false;n.install!==false?C=await Ee(g,n.packageManager??"pnpm",i):i.info("Skipping dependency installation"),n.git&&await Se(g,i);let H={status:"success",template:u.id,path:g,pro:P,manifest:E.join(g,Pe)};!C&&n.preview?i.warn("\u26A0\uFE0F  Cannot start the dev server because dependencies failed to install."):n.install===false&&n.preview&&i.warn("\u26A0\uFE0F  Install dependencies first (skip --no-install) to start the dev server automatically.");let S=false;if(C&&(S=await on(n,l)),await c.track({name:"new-site",payload:{template:u.id,sample:w,pro:P,ci:!!n.ci,packageManager:n.packageManager??"pnpm",install:n.install!==false,dependenciesReady:C,preview:S}}),S){await Lt(g,n.packageManager??"pnpm",i);return}if(l){i.json(H);return}i.success(`\u2705 Site created at ${g}`),i.info("\u{1F680} Next steps:"),i.info(`  \u{1F449} cd ${E.relative(process.cwd(),g)||g}`),n.install===false&&i.info(`  \u{1F449} ${n.packageManager??"pnpm"} install`),i.info("  \u{1F449} pnpm dev");});}async function on(r,e){return e||r.ci?false:typeof r.preview=="boolean"?r.preview:r.noPreview?false:R("Start the dev server now?",{initial:true})}async function sn(r,e,t){if(r.dir)return r.dir;if(e)return e;if(r.ci)return t.slug;let o=(await B("Project folder name",{initial:t.slug})).trim();return o?an(o)?o:z(o)||t.slug:t.slug}function an(r){return /[\\/]/.test(r)||r.includes(":")}async function Mt(r){let t=(await B("Enter your HugoBlox Pro license key (from your purchase confirmation email)",{initial:r??""})).trim();if(!t)throw new d("A HugoBlox Pro license key is required to continue. Check your purchase email or visit https://hugoblox.com/pro.");return t}var un=fileURLToPath(import.meta.url),Ke=E.dirname(un);function dn(){return Ke.endsWith("dist")?E.join(Ke,"lib","templates","minimal-theme.yaml"):E.resolve(Ke,"..","lib","templates","minimal-theme.yaml")}var Ut=dn();function pn(r){return /^[a-zA-Z0-9_-]+$/.test(r)}async function fn(){try{return await T.readFile(Ut,"utf8")}catch(r){throw new d(`Failed to load theme template: ${Ut}`,{error:r})}}function gn(r,e,t,n){let o=r.split(`
`),i=[],s=false,c=0;for(let a of o){if(a.trim()==="meta:"){s=true,c=a.indexOf("meta:"),i.push(a),i.push('    format: "hugoblox-theme@1"'),i.push(`    name: "${t}"`),i.push(`    vendor: "${e}"`),i.push('    version: "0.0.1"'),i.push('    license: "MIT"'),i.push('    description: "Created via HugoBlox CLI"');continue}if(s){a.trim()&&!a.startsWith(" ".repeat(c+2))&&a.indexOf(":")>0&&(s=false,i.push(a));continue}i.push(a);}return i.join(`
`)}function Vt(r,e){r.command("theme").description("Scaffold a new theme pack").argument("[name]","Theme slug/filename (will be converted to kebab-case)").option("--vendor <namespace>","Vendor namespace (e.g., GitHub username)").option("--theme-name <name>","Human-readable theme name (defaults to slug)").option("--git","Initialize a git repository").option("--ci","Run in non-interactive mode").action(async(t,n,o)=>{let{logger:i,telemetry:s}=e,c=!!o.optsWithGlobals().json;try{let a=n.vendor;if(!a){if(n.ci)throw new d("--vendor is required when running with --ci");a=await B("What is your GitHub username? (This will be your vendor namespace)");}if(a=a.trim(),!a)throw new d("Vendor namespace is required");if(!pn(a))throw new d("Vendor namespace must contain only alphanumeric characters, hyphens, and underscores");let l=t;if(!l){if(n.ci)throw new d("Theme slug is required when running with --ci");l=await B("What do you want to name your theme? (e.g., cyberpunk-neon)",{initial:"my-theme"});}if(l=l.trim(),!l)throw new d("Theme slug is required");let m=z(l),f=n.themeName;f||(n.ci?f=l:f=await B("Human-readable theme name?",{initial:l})),f=f.trim()||l;let b=E.join(process.cwd(),"data","themes",a),u=E.join(b,`${m}.yaml`);if(await v(u)){if(n.ci)throw new d(`Theme file already exists: ${u}`);if(!await R(`Theme file ${m}.yaml already exists. Overwrite?`,{initial:!1})){i.info("Theme creation cancelled");return}}let p=Ue("Creating theme...").start();try{await $(b);let g=await fn(),w=gn(g,a,f,m);await j(u,w),p.succeed("\u2705 Theme created successfully!");}catch(g){throw p.fail("Failed to create theme"),g}await s.track({name:"create-theme",payload:{vendor:a,themeFilename:m,ci:!!n.ci}});let h=E.relative(process.cwd(),u);if(c){i.json({status:"success",path:u,vendor:a,themeFilename:m,themeName:f});return}i.success(`
Theme created at: ${h}`),i.info(`
\u{1F4DD} To use this theme, update your params.yaml:`),i.info(`
hugoblox:`),i.info("  theme:"),i.info(`    pack: "${a}/${m}"`),n.ci||await R(`
\u{1F30D} Would you like to share this theme with the community?`,{initial:!1})&&(i.info(`
\u2728 Great! Here's how to publish your theme:`),i.info(`
1\uFE0F\u20E3  Create a new GitHub repository`),i.info("2\uFE0F\u20E3  In your repo, create a folder structure: hugoblox/themes/"),i.info(`3\uFE0F\u20E3  Copy your theme file to: hugoblox/themes/${m}.yaml`),i.info("4\uFE0F\u20E3  Commit and push to GitHub"),i.info(`
\u{1F4E2} Once published, others can install it with:
   hbx add theme --repo https://github.com/${a}/your-repo-name
`),i.info("\u{1F4A1} Tip: You can add multiple themes to the same repository!"));}catch(a){if(c){i.json({status:"error",message:a instanceof Error?a.message:String(a)});return}throw a}});}function Wt(r,e){let t=r.command("create").description("Create resources (site, theme, block)");Ft(t,e),Vt(t,e),Pt(t,e);}function Gt(r,e){yn(r,e),wn(r,e);}function yn(r,e){r.command("dev [hugoArgs...]").description("Start the Hugo development server (hugo server)").option("--path <dir>","Project directory (defaults to cwd)").option("--no-default-flags","Disable automatic --disableFastRender flag").action(async(t,n,o)=>{let{logger:i,telemetry:s}=e,a=!!o.optsWithGlobals().json,l=await Xt(n.path),m=["server"];n.defaultFlags!==false&&m.push("--disableFastRender"),m.push(...t),await Jt(m,l,i,{allowSignalExit:true,label:"dev server"}),await s.track({name:"dev",payload:{customPath:!!n.path,defaultFlags:n.defaultFlags!==false,args:t}}),a&&i.json({status:"success"});});}function wn(r,e){r.command("build [hugoArgs...]").description("Run a production Hugo build (hugo --gc --minify)").option("--path <dir>","Project directory (defaults to cwd)").option("--no-default-flags","Disable automatic --gc/--minify flags").action(async(t,n,o)=>{let{logger:i,telemetry:s}=e,a=!!o.optsWithGlobals().json,l=await Xt(n.path),m=[];n.defaultFlags!==false&&m.push("--gc","--minify"),m.push(...t),await Jt(m,l,i,{allowSignalExit:false,label:"build"}),await s.track({name:"build",payload:{customPath:!!n.path,defaultFlags:n.defaultFlags!==false,args:t}}),a&&i.json({status:"success"});});}async function Xt(r){let e=r?E.resolve(r):E.resolve(process.cwd()),t=await D(e);if(!t)throw new d("Unable to locate a HugoBlox project. Run this inside a project or pass --path.");return t.root}async function Jt(r,e,t,n){t.info(`Running: hugo ${r.join(" ")}`);try{await execa("hugo",r,{cwd:e,stdio:"inherit"}),t.success(`Hugo ${n.label} finished`);}catch(o){let i=o;if(n.allowSignalExit&&(i.signal==="SIGINT"||i.signal==="SIGTERM")){t.info("Hugo process stopped");return}throw new d(`Hugo ${n.label} failed: ${i.shortMessage??i.message}`,{error:i})}}var Cn=["github.com/HugoBlox/hugo-blox-builder","github.com/wowchemy/wowchemy-hugo-themes"];async function $e(r){let e=E.join(r,"go.mod"),t;try{t=await T.readFile(e,"utf8");}catch{return []}let o=kn(t).filter(s=>Cn.some(c=>s.path.startsWith(c)));return await Promise.all(o.map(async s=>{try{let c=await Pn(s.path);return {path:s.path,current:s.version,latest:c}}catch(c){return {path:s.path,current:s.version,latest:void 0,error:c.message}}}))}async function Pn(r){if(r.includes("github.com/HugoBlox/hugo-blox-builder"))return Sn(r)}async function Sn(r){let e=await oe(`${re}/repos/HugoBlox/hugo-blox-builder/tags?per_page=100`);if(!e.ok)throw new Error(`GitHub API error: ${e.status}`);let t=await e.json(),n=r.split("github.com/HugoBlox/hugo-blox-builder/");if(n.length<2)return;let o=n[1],i=t.filter(s=>s.name.startsWith(`${o}/`)&&/v\d+\.\d+\.\d+/.test(s.name)).map(s=>s.name);if(i.length!==0)return i.sort((s,c)=>{let a=s.split("/").pop()||"0.0.0",l=c.split("/").pop()||"0.0.0";return N.rcompare(a,l)}),i[0].split("/").pop()}async function qt(r,e){if(!r.includes("github.com/HugoBlox/hugo-blox-builder"))return;let t=r.split("github.com/HugoBlox/hugo-blox-builder/");if(t.length<2)return;let n=t[1],o=e==="main"||e.startsWith("v")?e:`v${e}`,i=e==="main"?"main":`${n}/${o.replace(/^v/,"v")}`,s=`${n}/hugo.yaml`,c=await oe(`${re}/repos/HugoBlox/hugo-blox-builder/contents/${s}?ref=${i}`,{headers:{Accept:"application/vnd.github.v3.raw"}});if(!c.ok)return;let a=await c.text();return He.parse(a)?.module?.hugoVersion?.min}function kn(r){let e=[],t=r.split(/\r?\n/),n=false;for(let o of t){let i=o.trim();if(i.startsWith("require (")){n=true;continue}if(n&&i===")"){n=false;continue}let s="";if(!n&&i.startsWith("require ")?s=i.replace("require","").trim():n&&(s=i),s){s=s.split("//")[0].trim();let c=s.split(/\s+/);c.length>=2&&e.push({path:c[0],version:c[1]});}}return e}function _e(r,e){if(!r||!e)return {updateAvailable:false,diff:""};let t=N.coerce(r),n=N.coerce(e);return !t||!n?{updateAvailable:false,diff:""}:N.lt(t,n)?{updateAvailable:true,diff:`${ae(r)} -> ${ae(e)}`}:{updateAvailable:false,diff:""}}function ae(r){let e=/v\d+\.\d+\.\d+-(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})-([a-f0-9]{12})/,t=r.match(e);if(t){let[n,o,i,s,c,a,l,m]=t;return `commit ${m.substring(0,7)} (released ${o}-${i}-${s})`}return r}function Yt(r){let e=process.env.HOME||process.env.USERPROFILE;if(!e)return r;let t=E.resolve(e),n=E.resolve(r);return n.startsWith(t)?n.replace(t,"~"):r}async function Ye(r,e){try{let t=await execa(r,e,{reject:!1});return t.exitCode===0?t.stdout.trim():`Failed (${t.stderr.trim()})`}catch(t){return `Not available (${t.message})`}}function Qt(r,e){r.command("doctor").description("Check local environment for common issues").action(async(t,n)=>{let{logger:o,config:i}=e,c=!!n.optsWithGlobals().json,a=[];a.push({name:"Node.js",ok:true,details:process.version});let l=await Ye("git",["--version"]);a.push({name:"Git",ok:!l.startsWith("Not"),details:l});let m=await Ye("hugo",["version"]);a.push({name:"Hugo",ok:!m.startsWith("Not"),details:m});let f=Tn(m),b=await Ye("pnpm",["--version"]);a.push({name:"pnpm",ok:!b.startsWith("Not"),details:b});let u=i.getLicense();a.push({name:"Pro license",ok:!!u,details:u?"Configured":"Missing"});let p=await D();if(p){let w=await ft(p.root);if(w){let x=w.templateName??w.templateId??"Unknown";a.push({name:"Template",ok:true,details:`${x} (${Yt(p.root)})`});let C=An(w.requiredHugoVersion,f);C&&a.push(C);}let P=await $e(p.root);for(let x of P){let C=x.path.split("/").pop()||x.path,H=x.current;if(x.latest){let k=N.coerce(x.current),A=N.coerce(x.latest);k&&A&&N.eq(k,A)&&(H=`${H} (latest)`);}a.push({name:`Module: ${C}`,ok:true,details:H});let{updateAvailable:S}=_e(x.current,x.latest);S&&x.latest&&a.push({name:`${C} update`,ok:false,details:`Current ${x.current}, latest ${x.latest}. Run 'hbx upgrade' to update.`,level:"warn"});}}let g={status:a.some(w=>(w.level??(w.ok?"info":"error"))==="error")?"error":"success",checks:a};if(c){o.json(g);return}for(let w of g.checks){let P=w.level??(w.ok?"info":"error");P==="info"?o.success(`${w.name}: ${w.details}`):P==="warn"?o.warn(`${w.name}: ${w.details}`):o.error(`${w.name}: ${w.details}`);}});}function Tn(r){let e=r.match(/v(\d+\.\d+\.\d+)/i);return e?e[1]:r.match(/(\d+\.\d+\.\d+)/)?.[1]}function An(r,e){if(!r||!e)return;let t=N.coerce(r),n=N.coerce(e);if(!(!t||!n))return N.lt(n,t)?{name:"Hugo version compatibility",ok:false,details:`Template requires Hugo ${t.version}, but ${n.version} is installed`,level:"error"}:N.major(n)>N.major(t)||N.minor(n)>N.minor(t)?{name:"Hugo version compatibility",ok:true,details:`Using Hugo ${n.version}; template tested with ${t.version}`,level:"warn"}:{name:"Hugo version compatibility",ok:true,details:`Template requires Hugo ${t.version} and you're running ${n.version}`,level:"info"}}function Zt(r,e){r.command("install").description("Hydrate HugoBlox Pro assets").option("--ci","Fail when prompts would appear").option("--force","Force re-download of assets").option("--path <dir>","Project directory (defaults to cwd)").action(async(t,n)=>{let{logger:o,config:i,telemetry:s}=e,a=!!n.optsWithGlobals().json,l=t.path?{root:E.resolve(t.path),manifestPath:E.join(E.resolve(t.path),"hbx.blocks.json")}:await D();if(!l)throw new d("Unable to locate a HugoBlox project - pass --path if needed");let m=i.getLicense();if(!m){if(t.ci)throw new d(`Missing license key. Set ${ee} or run hbx login before using --ci.`);o.warn("No Pro license detected, proceeding with OSS assets only");}let f=Ue("Hydrating Pro assets...").start();try{let u=E.join(l.root,"config","_default","module.hbx.toml"),p=E.join(l.root,"node_modules","@hugoblox-pro","sample");await $(p),await j(E.join(p,"README.md"),`# HugoBlox Pro assets placeholder
`),await j(u,`# Generated by hbx install
[[module.imports]]
path = "github.com/HugoBlox/hugo-blox-builder"
[[module.imports]]
path = "node_modules/@hugoblox-pro/sample"
`),f.succeed("Assets hydrated");}catch(u){throw f.fail("Failed to hydrate assets"),u}await s.track({name:"install",payload:{ci:!!t.ci,force:!!t.force,tokenPresent:!!m,customPath:!!t.path}});let b={status:"success",path:l.root,forced:!!t.force,token:!!m};a?o.json(b):(o.success("Install complete"),m||o.info("Tip: run hbx login to unlock Pro downloads"));});}function er(r,e){r.command("login").description("Authenticate with HugoBlox Pro and register this device for template access").option("--token <value>","License key").option("--ci","Fail when license key is missing").action(async(t,n)=>{let{config:o,logger:i}=e,c=!!n.optsWithGlobals().json,a=t.token;if(!a){if(t.ci)throw new d("License key is required when using --ci");a=await B("Enter your HugoBlox Pro license key");}let l=false;try{o.setLicense(a),await o.save(),l=!0,await L(e,{force:!0});let m={status:"success",token:Je(a)};c?i.json(m):i.success(`License key saved (${Je(a)})`);}catch(m){throw l&&(o.clearLicense(),await o.save()),$n(m)}});}function tr(r,e){r.command("logout").description("Remove stored HugoBlox credentials and device secrets").action(async(t,n)=>{let{config:o,logger:i}=e,s=!!n.optsWithGlobals().json;await Tt(o),o.clearLicense(),await o.save();let c={status:"success"};s?i.json(c):i.success("License key removed");});}function $n(r){let e=r instanceof Error?r.message:"Device registration failed",t="HBX must register this machine before downloading Pro templates. Check your internet connection, ensure your license has a free device slot, or revoke an old device and rerun 'hbx login'.";return r instanceof O?new d(`${e}. ${t}`,r.details):new d(`${e}. ${t}`)}function nr(r,e){r.command("migrate").description("Migrate HugoBlox project to newer versions").command("authors").description("Migrate author profiles from content/authors/ to data/authors/ (v0.11.0+)").option("-y, --yes","Skip confirmation prompts").option("--dry-run","Preview changes without modifying files").action(async n=>{let{logger:o}=e,i=await D();if(!i)throw new d("No Hugo project found in the current directory.");let s=Ue("Analyzing author profiles...").start();try{let c=E.join(i.root,"content","authors");if(!await v(c)){s.stop(),o.info("\u2139\uFE0F  No authors directory found. Nothing to migrate.");return}let a=await _n(c);if(a.length===0){s.stop(),o.info("\u2139\uFE0F  No author profiles found to migrate.");return}s.stop(),o.info(`
\u{1F4CB} Migration Plan (v0.11.0 Author System):
`),o.info(`   Found ${a.length} author profile(s):`);for(let m of a){let f=m.slug==="admin"?"me":m.slug;o.info(`     \u2022 ${m.slug} \u2192 data/authors/${f}.yaml`),m.avatarPath&&o.info(`       Avatar: ${E.basename(m.avatarPath)} \u2192 assets/media/authors/${f}${E.extname(m.avatarPath)}`);}if(o.info(`
   Changes:`),o.info("     \u2713 Create data/authors/ directory"),o.info("     \u2713 Generate YAML files with new schema (hugoblox/author/v1)"),o.info("     \u2713 Migrate avatar images to assets/media/authors/"),o.info("     \u2713 Update author references in content files"),o.info("     \u2713 Archive original content/authors/ directory"),n.dryRun){o.info(`
\u{1F50D} Dry run mode - no files will be modified.`);return}if(!n.yes&&!await R(`
This will restructure your author data. We recommend backing up first. Continue?`,{initial:!1})){o.info("Migration cancelled.");return}let l=await qn(i.root,a,o);if(o.info(""),l.success)o.success("\u2705 Migration complete!"),o.info(`   \u2022 Migrated ${l.authorsMigrated} author profile(s)`),o.info(`   \u2022 Updated ${l.contentFilesMigrated} content file(s)`),o.info(`
\u{1F4DA} Next steps:`),o.info("   1. Review generated files in data/authors/"),o.info("   2. Test your site: pnpm dev"),o.info("   3. Remove backup: rm -rf content/authors.backup");else {o.error("\u274C Migration completed with errors:");for(let m of l.errors)o.error(`   \u2022 ${m}`);o.info(`
   Original files preserved in content/authors/`);}}catch(c){throw s.stop(),c}});}async function _n(r){let e=[],t=await T.readdir(r,{withFileTypes:true});for(let o of t){if(!o.isDirectory()||o.name.startsWith("_"))continue;let i=E.join(r,o.name),s=E.join(i,"_index.md");if(!await v(s))continue;let c=Ze(o.name);if(c)try{let a=await T.readFile(s,"utf8"),{frontMatter:l,body:m}=Qe(a),f,u=(await T.readdir(i)).find(p=>/^avatar\.(png|jpg|jpeg|webp)$/i.test(p));u&&(f=E.join(i,u)),e.push({slug:o.name,targetSlug:c,originalPath:i,frontMatter:l,content:m.trim(),avatarPath:f});}catch{}}let n=E.join(r,"_index.md");if(await v(n))try{let o=await T.readFile(n,"utf8"),{frontMatter:i,body:s}=Qe(o);if(Hn(i,s)){let c=y(i.slug)??"admin",a=c?Ze(c):void 0;if(a&&!e.some(l=>l.targetSlug===a)){let l,f=(await T.readdir(r)).find(b=>/^avatar\.(png|jpg|jpeg|webp)$/i.test(b));f&&(l=E.join(r,f)),e.push({slug:c,targetSlug:a,originalPath:r,frontMatter:i,content:s.trim(),avatarPath:l});}}}catch{}return e}function Qe(r){let e=r.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);if(!e)return {frontMatter:{},body:r};try{let t=He.parse(e[1]);return typeof t!="object"||t===null||Array.isArray(t)?{frontMatter:{},body:r}:{frontMatter:t,body:e[2]??""}}catch{return {frontMatter:{},body:r}}}function Hn(r,e){return e.trim()?true:["title","name","first_name","last_name","bio","profiles","organizations","affiliations","interests","education","work","skills","languages","role","status","pronouns","name_pronunciation"].some(n=>r[n]!==void 0)}function Ze(r){let e=z(r);if(e)return e==="admin"?"me":e}function y(r){if(typeof r!="string")return;let e=r.trim();return e===""?void 0:e}function fe(r){return typeof r=="number"&&Number.isFinite(r)?r:y(r)}function jn(r){return Array.isArray(r)?r.map(e=>y(e)).filter(e=>!!e):[]}function Rn(r){let e={},t=y(r.title??r.name);t&&(e.display=t);let n=y(r.first_name??r.given_name??r.given);n&&(e.given=n);let o=y(r.last_name??r.family_name??r.family);o&&(e.family=o);let i=y(r.middle_name??r.middle);i&&(e.middle=i);let s=y(r.nickname??r.alternate_name??r.alt_name);s&&(e.alternate=s);let c=y(r.name_pronunciation??r.pronunciation);c&&(e.pronunciation=c);let a=y(r.pronouns);return a&&(e.pronouns=a),e}function Dn(r){if(r.status&&typeof r.status=="object"&&!Array.isArray(r.status)){let t=y(r.status.icon);if(t)return {icon:t}}let e=y(r.status_icon??r.status_emoji??r.status);if(e)return {icon:e}}function Bn(r){return Array.isArray(r)?r.map(e=>{if(typeof e!="object"||e===null)return;let t=e,n=y(t.name);if(!n)return;let o=y(t.url);return o?{name:n,url:o}:{name:n}}).filter(e=>!!e):[]}function Ln(r){let e={},t=["orcid","google_scholar","openalex","semantic_scholar","research_gate","scopus","arxiv"];for(let i of t){let s=y(r[i]);s&&(e[i]=s);}let n=[];Array.isArray(r.profiles)&&n.push(...r.profiles);let o=r.links;Array.isArray(o)&&n.push(...o);for(let i of n){if(typeof i!="object"||i===null)continue;let s=y(i.url);s&&Nn(s,e);}return Object.keys(e).length===0?void 0:e}function Nn(r,e){if(/^https?:\/\//i.test(r))try{let t=new URL(r),n=t.hostname.toLowerCase(),o=t.pathname.split("/").filter(Boolean);if(n.includes("scholar.google.")){let i=t.searchParams.get("user");i&&!e.google_scholar&&(e.google_scholar=i);return}if(n.includes("orcid.org")){let i=t.pathname.match(/(\d{4}-\d{4}-\d{4}-\d{3}[0-9X])/i);i&&!e.orcid&&(e.orcid=i[1]);return}if(n.includes("openalex.org")){let i=o[o.length-1];i&&!e.openalex&&(e.openalex=i);return}if(n.includes("semanticscholar.org")){let i=o[o.length-1];i&&!e.semantic_scholar&&(e.semantic_scholar=i);return}if(n.includes("researchgate.net")){let i=o[o.length-1];i&&!e.research_gate&&(e.research_gate=i);return}if(n.includes("scopus.com")){let i=t.searchParams.get("authorId")??t.searchParams.get("scopusId")??o[o.length-1];i&&!e.scopus&&(e.scopus=i);return}if(n.includes("arxiv.org")){let i=o[o.length-1];i&&!e.arxiv&&(e.arxiv=i);}}catch{}}function On(r,e,t){let n=[];if(Array.isArray(r))for(let s of r){if(typeof s!="object"||s===null)continue;let c=s,a=y(c.icon),l=y(c.url),m=y(c.label);if(a&&l){let f={icon:a,url:l};m&&(f.label=m),n.push(f);}}let o=y(t);if(o){let s=o.startsWith("mailto:")?o:`mailto:${o}`;n.some(c=>c.url===s)||n.push({icon:"at-symbol",url:s,label:"Email"});}let i=y(e);return i&&!n.some(s=>s.url===i)&&n.push({icon:"link",url:i,label:"Website"}),n}function Mn(r){if(typeof r=="string"){let e=r.trim();return e||void 0}if(Array.isArray(r)){let e=r.map(t=>y(t)).filter(t=>!!t);if(e.length>0)return e}}function Fn(r){return Array.isArray(r)?r.map(e=>{if(typeof e!="object"||e===null)return;let t=e,n=y(t.institution??t.organization??t.school);if(!n)return;let o={institution:n},i=y(t.degree??t.area??t.qualification);i&&(o.degree=i);let s=fe(t.year);s!==void 0&&(o.year=s);let c=fe(t.start??t.date_start);c!==void 0&&(o.start=c);let a=fe(t.end??t.date_end);a!==void 0&&(o.end=a);let l=y(t.summary);l&&(o.summary=l);let m=or(t.button);return m&&(o.button=m),o}).filter(e=>!!e):[]}function Un(r){return Array.isArray(r)?r.map(e=>{if(typeof e!="object"||e===null)return;let t=e,n=y(t.role??t.position),o=y(t.org??t.company_name??t.company);if(!n||!o)return;let i={role:n,org:o},s=fe(t.start??t.date_start);s!==void 0&&(i.start=s);let c=fe(t.end??t.date_end);c!==void 0&&(i.end=c);let a=y(t.summary);a&&(i.summary=a);let l=or(t.button);return l&&(i.button=l),i}).filter(e=>!!e):[]}function or(r){if(typeof r!="object"||r===null)return;let e=r,t=y(e.url);if(!t)return;let n={url:t},o=y(e.text);o&&(n.text=o);let i=y(e.icon);return i&&(n.icon=i),n}function Vn(r){return Array.isArray(r)?r.map(e=>{if(typeof e!="object"||e===null)return;let t=e,o=(Array.isArray(t.items)?t.items:[]).map(c=>{if(typeof c!="object"||c===null)return;let a=c,l=y(a.label??a.name);if(!l)return;let m={label:l},f=ir(a.level)??et(typeof a.percent=="number"?a.percent:void 0);f!==void 0&&(m.level=f);let b=y(a.icon);return b&&(m.icon=b),m}).filter(c=>!!c);if(o.length===0)return;let i={items:o},s=y(t.name);return s&&(i.name=s),i}).filter(e=>!!e):[]}function et(r){if(typeof r!="number"||Number.isNaN(r)||r<=0)return;let e=Math.min(100,r);return Math.max(1,Math.min(5,Math.ceil(e/20)))}function ir(r){if(!(typeof r!="number"||Number.isNaN(r)))return r>=1&&r<=5?Math.round(r):et(r)}function Wn(r){return Array.isArray(r)?r.map(e=>{if(typeof e=="string"){let a=y(e);return a?{name:a}:void 0}if(typeof e!="object"||e===null)return;let t=e,n=y(t.name??t.label);if(!n)return;let o=typeof t.percent=="number"?Math.max(0,Math.min(100,t.percent)):void 0,i=ir(t.level)??et(o),s={name:n};i!==void 0&&(s.level=i),o!==void 0&&(s.percent=o);let c=y(t.label)??zn(o,i);return c&&(s.label=c),s}).filter(e=>!!e):[]}function zn(r,e){let t=r??(typeof e=="number"?e*20:void 0);if(t!==void 0){if(t>=99)return "Native";if(t>=90)return "C2";if(t>=75)return "C1";if(t>=60)return "B2";if(t>=45)return "B1";if(t>=30)return "A2"}}function Gn(r){return Array.isArray(r)?r.map(e=>{if(typeof e=="string"){let l=y(e);return l?{title:l}:void 0}if(typeof e!="object"||e===null)return;let t=e,n=y(t.title);if(!n)return;let o={title:n},i=y(t.awarder);i&&(o.awarder=i);let s=y(t.date);s&&(o.date=s);let c=y(t.summary);c&&(o.summary=c);let a=y(t.icon);return a&&(o.icon=a),o}).filter(e=>!!e):[]}function Xn(r,e){let{frontMatter:t,content:n}=r,o={schema:"hugoblox/author/v1",slug:e},i=Rn(t);Object.keys(i).length>0&&(o.name=i),t.superuser===true&&(o.is_owner=true);let s=Dn(t);s&&(o.status=s);let c=y(t.role);c&&(o.role=c);let a=y(t.bio)??n.trim();a&&(o.bio=a);let l=Bn(t.organizations??t.affiliations);l.length>0&&(o.affiliations=l);let m=Ln(t);m&&(o.ids=m);let f=[];Array.isArray(t.profiles)&&f.push(...t.profiles);let b=t.links;Array.isArray(b)&&f.push(...b);let u=On(f,t.website,t.email);u.length>0&&(o.links=u);let p=jn(t.interests);p.length>0&&(o.interests=p);let h=Mn(t.postnominals??t.credentials);h&&(o.postnominals=h);let g=Fn(t.education);g.length>0&&(o.education=g);let w=Un(t.work??t.experience);w.length>0&&(o.experience=w);let P=Vn(t.skills);P.length>0&&(o.skills=P);let x=Wn(t.languages);x.length>0&&(o.languages=x);let C=Gn(t.awards);return C.length>0&&(o.awards=C),typeof t.weight=="number"&&Number.isFinite(t.weight)&&(o.weight=Math.trunc(t.weight)),o}async function Jn(r,e,t){let n=E.extname(r)||".png",o=E.join(e,`${t}${n}`);return await T.copyFile(r,o),o}async function qn(r,e,t){let n={success:true,authorsMigrated:0,contentFilesMigrated:0,errors:[]},o=Ue("Creating backup...").start(),i=E.join(r,"content","authors"),s=E.join(r,"content","authors.backup");try{if(await v(s)){let p=new Date().toISOString().replace(/[:.]/g,"-").split(".")[0],h=`${s}.${p}`;o.text=`Existing backup found, creating timestamped backup: ${E.basename(h)}`,await T.cp(i,h,{recursive:!0}),t.info(`   Previous backup preserved as: ${E.basename(h)}`);}else await T.cp(i,s,{recursive:!0});o.text="Backup created, migrating author profiles...";let c=E.join(r,"data","authors"),a=E.join(r,"assets","media","authors");if(await v(c)){let h=(await T.readdir(c)).filter(g=>g.endsWith(".yaml")||g.endsWith(".yml"));if(h.length>0)throw o.stop(),new d(`data/authors/ already contains ${h.length} YAML file(s).
Please remove or back them up manually before running migration.`)}await $(c),await $(a);let l=new Map,m=new Set,f=[],b=[];for(let p of e){let h=p.targetSlug??Ze(p.slug);if(!h){b.push(p.slug);continue}m.has(h)&&f.push(h),m.add(h);let g=new Set([p.slug]),w=p.slug.toLowerCase();w!==p.slug&&g.add(w);let P=z(p.slug);P&&P!==p.slug&&g.add(P);for(let x of g)l.has(x)||l.set(x,h);}if(b.length>0)throw o.stop(),new d(`Unable to normalize the following author slug(s): ${b.join(", ")}
Please rename them to use lowercase letters, numbers, or hyphens.`);if(f.length>0)throw o.stop(),new d(`Slug collision detected: Multiple profiles would map to: ${f.join(", ")}
Please manually rename one of the conflicting profiles before migration.`);for(let p=0;p<e.length;p++){let h=e[p];o.text=`Migrating profiles... (${p+1}/${e.length})`;try{let g=l.get(h.slug);if(!g)throw new d(`Unable to determine target slug for '${h.slug}'`);let w=Xn(h,g),P=E.join(c,`${g}.yaml`),x=He.stringify(w,{defaultStringType:"QUOTE_DOUBLE",lineWidth:0});try{let C=He.parse(x);if(!C.schema||!C.slug)throw new Error("Generated YAML missing required fields")}catch(C){throw new Error(`Invalid YAML generated: ${String(C)}`)}if(await T.writeFile(P,x,"utf8"),h.avatarPath)try{await Jn(h.avatarPath,a,g);}catch(C){n.errors.push(`\u2713 Profile '${h.slug}' migrated, but avatar copy failed: ${String(C)}`);}n.authorsMigrated++;}catch(g){n.errors.push(`Failed to migrate ${h.slug}: ${String(g)}`),n.success=!1;}}o.text="Updating content references...";let u=E.join(r,"content");if(await v(u)){let p=await Kn(u,l);n.contentFilesMigrated=p;}o.text="Finalizing migration...",await T.rm(i,{recursive:!0,force:!0}),o.succeed("Migration complete");}catch(c){o.fail("Migration failed"),n.success=false,n.errors.push(String(c));try{t.warn("\u26A0\uFE0F  Attempting to rollback changes..."),!await v(i)&&await v(s)&&(await T.cp(s,i,{recursive:!0}),t.info("   \u2713 Original authors directory restored from backup"));let a=E.join(r,"data","authors");await v(a)&&(await T.readdir(a)).filter(b=>b.endsWith(".yaml")).length===n.authorsMigrated&&(await T.rm(a,{recursive:!0,force:!0}),t.info("   \u2713 Partial data/authors/ files removed"));let l=E.join(r,"assets","media","authors");await v(l)&&(await T.readdir(l)).length<=n.authorsMigrated&&(await T.rm(l,{recursive:!0,force:!0}),t.info("   \u2713 Partial avatar files removed")),t.info("\u2713 Rollback complete. Your original files are safe.");}catch(a){n.errors.push(`Rollback failed: ${String(a)}`),t.error("\u274C Rollback failed. Please manually check:"),t.error("   - content/authors.backup/ contains your original files"),t.error("   - You may need to manually restore them");}}return n}async function Kn(r,e){let t=0;for await(let n of sr(r))try{let o=await T.readFile(n,"utf8"),{frontMatter:i,body:s}=Qe(o),c=!1;if(Array.isArray(i.authors)){let a=i.authors.map(l=>{if(typeof l=="string"){let m=l.trim(),f=m.toLowerCase(),b=e.get(m)??e.get(l)??e.get(f);if(b)return c=!0,b}return l});i.authors=a;}if(c){let a=`---
${He.stringify(i)}---

${s}`;await T.writeFile(n,a,"utf8"),t++;}}catch{}return t}async function*sr(r){let e;try{e=await T.readdir(r,{withFileTypes:!0});}catch{return}for(let t of e){let n=E.join(r,t.name);if(t.isDirectory()){if(t.name==="authors"||t.name==="authors.backup")continue;try{if((await T.lstat(n)).isSymbolicLink())continue}catch{continue}yield*sr(n);}else t.name.endsWith(".md")&&(yield n);}}function ar(r,e){let t=r.command("telemetry").description("Manage HugoBlox telemetry preferences");t.command("enable").description("Enable anonymous telemetry").action(async()=>{e.config.setTelemetryEnabled(true),await e.config.save(),e.logger.success("Telemetry enabled. Thanks for helping improve HugoBlox!");}),t.command("disable").description("Disable telemetry collection").action(async()=>{e.config.setTelemetryEnabled(false),await e.config.save(),e.logger.success("Telemetry disabled. You can re-enable it anytime.");}),t.command("status").description("Show whether telemetry is enabled").action(()=>{let n=e.config.isTelemetryEnabled();e.logger.info(`Telemetry is ${n?"enabled":"disabled"}.`);}),t.action(()=>{let n=e.config.isTelemetryEnabled();e.logger.info(`Telemetry is ${n?"enabled":"disabled"}.`),e.logger.info("Use 'hbx telemetry enable|disable' to change the setting.");});}async function lr(r,e,t){let n=N.coerce(e)?.version;if(!n)return;let o=[{path:"hugoblox.yaml",regex:/(hugo_version:\s*['"]?)([\d.]+)(['"]?)/,name:"hugoblox.yaml"},{path:"netlify.toml",regex:/(HUGO_VERSION\s*=\s*['"])([\d.]+)(['"])/,name:"netlify.toml"},{path:".github/workflows/deploy.yml",regex:/(WC_HUGO_VERSION:\s*['"]?)([\d.]+)(['"]?)/,name:"GitHub Actions"}];for(let i of o){let s=E.join(r,i.path);if(await v(s))try{let c=await T.readFile(s,"utf8"),a=c.match(i.regex);if(a){let l=a[2],m=N.coerce(l),f=N.coerce(n);if(m&&f&&N.lt(m,f)){let b=c.replace(i.regex,`$1${n}$3`);await T.writeFile(s,b,"utf8"),t.success(`Updated ${i.name} Hugo version to ${n}`);}}}catch{}}}function dr(r,e){r.command("upgrade").alias("update").description("Upgrade HugoBlox modules to the latest version").option("-y, --yes","Skip confirmation").option("--ci","Run in non-interactive mode").option("--force","Force upgrade even if Hugo version is incompatible").option("--canary","Upgrade to the latest development commit (main branch) instead of stable release").action(async(t,n)=>{let{logger:o}=e;await yt()||(o.error("\u274C You appear to be offline. Please check your internet connection."),process.exit(1));let i=await D();if(!i)throw new d("No Hugo project found in the current directory.");let s=Ue("Checking for updates...").start(),c=await $e(i.root);if(c.length===0){s.stop(),o.info("\u2139\uFE0F  No official HugoBlox modules found in go.mod");return}let a=c.filter(u=>u.error);if(a.length>0){s.stop(),o.error("\u274C Failed to check for updates for some modules:");for(let u of a)o.error(`   ${u.path}: ${u.error}`);process.exit(1);}let l=[];if(t.canary)s.text="Checking canary versions...",l.push(...c.map(u=>({path:u.path,version:"main"})));else {let u=c.map(p=>{let{updateAvailable:h,diff:g}=_e(p.current,p.latest);return {...p,updateAvailable:h,diff:g}}).filter(p=>p.updateAvailable&&p.latest);if(u.length===0){s.stop(),o.success("\u2705 All HugoBlox modules are up to date");return}l.push(...u.map(p=>({path:p.path,version:p.latest||""})));}s.text="Checking version requirements...";let m=await Promise.all(l.map(async u=>{try{let p=await qt(u.path,u.version);return {...u,min:p}}catch{return {...u,min:void 0}}}));if(s.stop(),!t.force){let u=await gt();if(u){let p=m.filter(h=>{if(!h.min)return  false;let g=N.coerce(h.min),w=N.coerce(u);return g&&w&&N.lt(w,g)});if(p.length>0){o.error("\u274C Hugo version incompatible with upgrade targets:");for(let h of p)o.error(`   ${h.path.split("/").pop()} requires Hugo >= ${h.min} (you have ${u})`);o.info("\u{1F449} Please upgrade Hugo first: https://docs.hugoblox.com/start/cli"),o.info("   Or run with --force to ignore this check."),process.exit(1);}}else o.warn("\u26A0\uFE0F  Could not detect local Hugo version. Skipping compatibility check.");}if(t.canary){o.warn("\u26A0\uFE0F  Upgrading modules to latest canary (development) version.");for(let u of c)o.info(`   ${u.path.split("/").pop()}: ${ae(u.current)} -> @main`);}else {o.info(`\u{1F4E6} Updates available for ${l.length} module(s):`);for(let u of l){let p=c.find(h=>h.path===u.path)?.current||"?";o.info(`   ${u.path.split("/").pop()}`),o.info(`     Current: ${ae(p)}`),o.info(`     Latest:  ${ae(u.version)}`);}}if(!t.yes&&!t.ci&&!await R(t.canary?"Are you sure you want to upgrade to the bleeding edge?":"Do you want to upgrade now?",{initial:true})){o.info("Upgrade cancelled");return}let f=l.map(u=>`${u.path}@${u.version}`);await Qn(i.root,f,o);let b=m.reduce((u,p)=>{if(!p.min)return u;let h=N.coerce(p.min),g=N.coerce(u);return h&&(!g||N.gt(h,g))?p.min:u},void 0);b&&await lr(i.root,b,o),o.info(""),o.warn("\u26A0\uFE0F  Important: Please review the release notes for any breaking changes."),o.info("\u{1F449} https://github.com/HugoBlox/hugo-blox-builder/releases");});}async function Qn(r,e,t){let n=Ue("Upgrading modules...").start();try{await execa("hugo",["mod","get",...e],{cwd:r}),n.text="Tidying go.mod...",await execa("hugo",["mod","tidy"],{cwd:r}),n.succeed(`\u2705 Upgraded ${e.length} module(s)`);}catch(o){n.fail("Failed to upgrade modules"),t.error(String(o)),process.exit(1);}}var K;function Y(){if(K)return K;let r=process.env.HBX_CLI_VERSION??process.env.npm_package_version;if(r)return K=r,K;let e=eo(import.meta.url);try{let t=F.readFileSync(e,"utf8");K=JSON.parse(t).version??"0.0.0";}catch{K="0.0.0";}return K}function eo(r){let e=E.dirname(fileURLToPath(r)),t=E.resolve(e,"../package.json");return F.existsSync(t)?t:E.resolve(e,"../../package.json")}function fr(r,e){r.command("version").description("Print CLI version").action((t,n)=>{let{logger:o}=e,i=!!n.optsWithGlobals().json,s=Y(),c={status:"success",version:s};i?o.json(c):o.info(`hbx ${s}`);});}var me=class r{#e;constructor(e){this.#e=e;}static async load(){try{let e=await T.readFile(xe,"utf8"),t=JSON.parse(e);return new r(t)}catch(e){if(e.code==="ENOENT")return new r({});throw new he("Failed to read configuration",{error:e})}}toJSON(){return this.#e}getLicense(){return process.env[ee]??this.#e.token}setLicense(e){this.#e={...this.#e,token:e};}clearLicense(){let e={...this.#e};e.token=void 0,e.device=void 0,this.#e=e;}isTelemetryEnabled(){return process.env[st]==="1"?false:typeof this.#e.telemetry?.enabled=="boolean"?this.#e.telemetry.enabled:true}setTelemetryEnabled(e){this.#e={...this.#e,telemetry:{...this.#e.telemetry,enabled:e,lastPrompted:Date.now()}};}getTelemetryId(){return this.#e.telemetry?.id}async ensureTelemetryId(){let e=this.getTelemetryId();if(e)return e;let t=pe.randomUUID();return this.#e={...this.#e,telemetry:{...this.#e.telemetry,id:t}},await this.save(),t}getDefaultTemplate(){return this.#e.defaults?.template}getUpdateMetadata(){return this.#e.updates}setUpdateMetadata(e){this.#e={...this.#e,updates:{...this.#e.updates,...e}};}getDeviceInfo(){return this.#e.device}setDeviceInfo(e){this.#e={...this.#e,device:e};}async save(){await T.mkdir(Oe,{recursive:true});let e=JSON.stringify(this.#e,null,2);await T.writeFile(xe,e,{mode:384}),await T.chmod(xe,384);}};var ue=class{#e;#t;constructor(e={}){this.#e=e.json??false,this.#t=e.debug??process.env[G]==="1";}isJsonMode(){return this.#e}setJsonMode(e){this.#e=e;}setDebug(e){this.#t=e;}info(e){this.#e||process.stdout.write(`${ge.blue("i")} ${e}
`);}success(e){this.#e||process.stdout.write(`${ge.green("\u2714")} ${e}
`);}warn(e){this.#e||process.stdout.write(`${ge.yellow("!")} ${e}
`);}error(e){this.#e||process.stderr.write(`${ge.red("\u2716")} ${e}
`);}debug(e){!this.#t||this.#e||process.stdout.write(`${ge.gray("debug")} ${e}
`);}json(e){let t=JSON.stringify(e,null,2);process.stdout.write(`${t}
`);}};var no=new Set(["command","project","duration","status","errorCode","errorMessage","metadata"]),oo=50,io=6144,gr=25e3,Q=class{#e;#t;#n;#o=[];#r;#i=false;#s;#a;#c;constructor(e,t,n){this.#e=e,this.#t=t,this.#n=n,this.#a=process.env.HBX_RELEASE_CHANNEL??process.env.RELEASE_CHANNEL??"stable",this.#c=randomUUID(),this.#l();}isEnabled(){return this.#e.isTelemetryEnabled()}setCommand(e){this.#s=e;}async track(e){this.isEnabled()&&(this.#o.push({...e,timestamp:new Date().toISOString(),payload:e.payload??{}}),await this.flush());}async flush(){if(!this.#o.length)return;if(this.#r){await this.#r;return}let e=this.#o.splice(0);this.#r=this.#m(e).finally(()=>{this.#r=void 0;}),await this.#r;}#l(){if(this.#i)return;let e=()=>{this.flush();};process.once("beforeExit",e),process.once("exit",e),process.once("SIGINT",e),process.once("SIGTERM",e),this.#i=true;}async#m(e){if(!e.length)return;let t=this.#e.getTelemetryId(),o=[...e.map(i=>co(i))];for(;o.length;){let i=[],s;for(;o.length&&i.length<oo;){let c=o[0];if(!c)break;let a=[...i,c],l=this.#u(a,t),m=JSON.stringify(l);if(Buffer$1.byteLength(m,"utf8")>gr){if(!i.length){o.shift(),this.#t.warn("Dropped telemetry event because payload exceeded max size");continue}break}let f=o.shift();if(!f)break;i.push(f),s=m;}!i.length||!s||await this.#d(s,t);}}#u(e,t){return {clientId:t&&t.length>=8?t:"anonymous",os:De.platform(),osVersion:ao(),arch:process.arch,nodeVersion:process.version,ci:so(),command:this.#s,releaseChannel:this.#a,sessionId:this.#c,cliVersion:this.#n,version:this.#n,hasLicense:!!this.#e.getLicense(),events:e}}async#d(e,t){let n=Buffer$1.byteLength(e,"utf8");if(n>gr){this.#t.warn("Telemetry payload skipped because it exceeded the maximum request size");return}try{let o=new AbortController,i=setTimeout(()=>o.abort(),5e3),s=await fetch(ut,{method:"POST",headers:{"Content-Type":"application/json","Content-Length":String(n),"User-Agent":`hbx-cli/${this.#n}`,...t?{"x-telemetry-id":t}:void 0},body:e,signal:o.signal});if(clearTimeout(i),s.status===413){this.#t.warn("Telemetry payload rejected (too large)");return}if(!s.ok)throw new Error(`telemetry responded with status ${s.status}`)}catch(o){this.#t.debug(`telemetry send failed: ${String(o)}`);}}};function so(){return process.env.CI==="1"||process.env.CONTINUOUS_INTEGRATION==="1"||!!process.env.BUILD_NUMBER||!!process.env.RUN_ID}function ao(){let r=De.version;if(typeof r=="function")try{return r()}catch{return De.release()}return De.release()}function co(r){let e=lo(r.payload);if(!e){let{payload:t,...n}=r;return n}try{let t=JSON.stringify(e);return Buffer$1.byteLength(t,"utf8")>io?{...r,payload:{truncated:!0}}:{...r,payload:e}}catch{return {...r,payload:{truncated:true}}}}function lo(r){if(!r||typeof r!="object")return;let e={};for(let t of no)if(Object.hasOwn(r,t)){let n=r[t];if(t==="metadata"&&(n==null||typeof n!="object"))continue;e[t]=n;}return Object.keys(e).length?e:void 0}async function yr(r,e,t){if(process.env[at]==="1")return;let n=e.getUpdateMetadata()??{},o=Date.now(),i=n.latestVersion,s=n.lastChecked??0;if(!i||o-s>dt){let l=await uo(r,t);l.latestVersion&&(i=l.latestVersion),l.checkedAt>0&&(s=l.checkedAt,e.setUpdateMetadata({lastChecked:s,latestVersion:i}),await e.save());}if(!i||!N.valid(i)||!N.gt(i,r)||!mo(n,o,i))return;let a=`npm install -g ${Ce}`;t.warn(`A new version of hbx is available: ${i} (current ${r}).
Update with: ${a} (or pnpm add -g ${Ce}).`),e.setUpdateMetadata({lastNotifiedAt:o,latestVersion:i}),await e.save();}function mo(r,e,t){return !r||r.lastNotifiedAt===void 0||r.latestVersion!==t?true:e-r.lastNotifiedAt>pt}async function uo(r,e){try{let t=await fetch(`https://registry.npmjs.org/${encodeURIComponent(Ce)}/latest`,{headers:{"User-Agent":`hbx-cli/${r}`}});if(!t.ok)throw new Error(`npm registry responded with status ${t.status}`);return {latestVersion:(await t.json()).version,checkedAt:Date.now()}}catch(t){return e.debug(`update check failed: ${String(t)}`),{checkedAt:Date.now()}}}var Be=class{constructor(e){this.context=e;this.cancelled=false;}async*create(e){this.cancelled=false;try{if(yield*this.validateConfiguration(e),this.cancelled||(yield*this.fetchTemplate(e.templateId),this.cancelled)||(yield*this.scaffoldSite(e),this.cancelled)||e.options?.autoInstall!==!1&&(yield*this.installDependencies(e),this.cancelled)||e.options?.initGit!==!1&&(yield*this.initializeGit(e),this.cancelled))return;yield*this.completeCreation(e);}catch(t){yield {id:"error",type:"error",title:"Creation Failed",message:t instanceof Error?t.message:String(t),timestamp:new Date,data:{error:t,config:e}};}}async*validateConfiguration(e){yield this.createProgressStep("validate",0,"Starting validation..."),yield this.createProgressStep("validate",25,"Checking template availability...");let t=await this.validate(e);if(yield this.createProgressStep("validate",75,"Validating target path..."),!t.valid)throw new Error(`Validation failed: ${t.errors[0]?.message}`);for(let n of t.warnings)yield {id:"validate",type:"warning",title:"Configuration Warning",message:n.message,timestamp:new Date,data:{field:n.field,suggestion:n.suggestion}};yield this.createSuccessStep("validate","Configuration validated");}async*fetchTemplate(e){yield this.createProgressStep("fetch_template",0,"Fetching available templates...");let t=await V(this.context);yield this.createProgressStep("fetch_template",50,"Locating template...");let n=t.find(o=>o.id===e);if(!n)throw new Error(`Template "${e}" not found`);yield this.createProgressStep("fetch_template",75,`Found template: ${n.name}`),await this.delay(500),yield this.createSuccessStep("fetch_template",`Template "${n.name}" ready`,{template:n});}async*scaffoldSite(e){let n=(await V(this.context)).find(s=>s.id===e.templateId);if(!n)throw new Error(`Template "${e.templateId}" not found`);yield this.createProgressStep("scaffold_site",0,"Preparing target directory...");let o=Te(e.targetPath,n.slug);await we(o),yield this.createProgressStep("scaffold_site",25,"Copying template files...");let i={sampleContent:e.options?.includeSampleContent??true,includeEnv:true,packageManager:e.packageManager||"pnpm"};await ke(this.context,o,n,i),yield this.createProgressStep("scaffold_site",75,"Customizing site configuration..."),await this.customizeSiteConfig(o,e),yield this.createSuccessStep("scaffold_site","Site structure created",{targetDir:o,templateId:e.templateId});}async*installDependencies(e){let t=e.packageManager||"pnpm",n=e.targetPath;yield this.createProgressStep("install_deps",0,`Starting ${t} install...`);try{await Ee(n,t,this.context.logger)?yield this.createSuccessStep("install_deps","Dependencies installed successfully"):yield {id:"install_deps",type:"warning",title:"Dependencies installation skipped",message:"Some dependencies failed to install, but site creation can continue",timestamp:new Date};}catch(o){throw new Error(`Failed to install dependencies: ${String(o)}`)}}async*initializeGit(e){yield this.createProgressStep("init_git",0,"Initializing git repository..."),await Se(e.targetPath,this.context.logger),yield this.createProgressStep("init_git",75,"Creating initial commit..."),await this.delay(1e3),yield this.createSuccessStep("init_git","Git repository initialized");}async*completeCreation(e){yield this.createProgressStep("complete",50,"Finalizing setup..."),await this.generateSummaryReport(e),yield {id:"complete",type:"success",title:`Site "${e.siteName}" created successfully! \u{1F389}`,progress:100,timestamp:new Date,data:{siteName:e.siteName,targetPath:e.targetPath,templateId:e.templateId,packageManager:e.packageManager,nextSteps:this.generateNextSteps(e)}};}async validate(e){let t=[],n=[];(await V(this.context)).find(s=>s.id===e.templateId)||t.push({field:"templateId",message:`Template "${e.templateId}" not found`,code:"TEMPLATE_NOT_FOUND"}),(!e.siteName||e.siteName.trim().length===0)&&t.push({field:"siteName",message:"Site name is required",code:"SITE_NAME_REQUIRED"});let i=await Ae(e.targetPath);return i.valid||t.push({field:"targetPath",message:i.error||"Invalid target path",code:"INVALID_PATH"}),i.exists&&!i.isEmpty&&n.push({field:"targetPath",message:"Directory is not empty",suggestion:"Files may be overwritten during site creation"}),{valid:t.length===0,errors:t,warnings:n}}async cancel(){this.cancelled=true;}createProgressStep(e,t,n,o){return {id:e,type:"progress",title:this.getStepTitle(e),message:n,progress:t,timestamp:new Date,data:o}}createSuccessStep(e,t,n){return {id:e,type:"success",title:this.getStepTitle(e),message:t,progress:100,timestamp:new Date,data:n}}getStepTitle(e){return {validate:"Validating configuration",fetch_template:"Fetching template",scaffold_site:"Creating site structure",install_deps:"Installing dependencies",init_git:"Initializing git repository",start_server:"Starting development server",complete:"Finalizing setup"}[e]||e}async delay(e){return new Promise(t=>setTimeout(t,e))}async customizeSiteConfig(e,t){this.context.logger.debug(`Customizing site config for ${t.siteName}`);}async generateSummaryReport(e){this.context.logger.debug(`Site creation completed: ${JSON.stringify({template:e.templateId,path:e.targetPath,options:e.options})}`);}generateNextSteps(e){let t=[`cd ${e.targetPath}`];return e.options?.autoInstall===false&&t.push(`${e.packageManager||"pnpm"} install`),e.options?.autoPreview!==false&&t.push(`${e.packageManager||"pnpm"} dev`),t}};var Le=class r{constructor(e){this.context=e;}static{this.PREVIEW_DATA={"academic-cv":{thumbnailUrl:"https://hugoblox.com/previews/academic-cv-thumb.jpg",category:"academic",difficulty:"beginner",estimatedTime:3,features:["Publication lists","Research sections","Academic timeline","Contact forms"],useCases:["Professors","Researchers","PhD students","Academic professionals"]},startup:{thumbnailUrl:"https://hugoblox.com/previews/startup-thumb.jpg",category:"business",difficulty:"intermediate",estimatedTime:5,features:["Landing pages","Pricing tables","Team sections","Newsletter signup"],useCases:["SaaS companies","Startups","Product launches","Marketing sites"]},folio:{thumbnailUrl:"https://hugoblox.com/previews/folio-thumb.jpg",category:"portfolio",difficulty:"beginner",estimatedTime:2,features:["Project galleries","About sections","Contact forms","Responsive design"],useCases:["Designers","Developers","Freelancers","Creative professionals"]}};}async enrichWithPreviews(e,t){let n=e.map(o=>this.enrichTemplate(o));return t?this.applyQueryOptions(n,t):n}enrichTemplate(e){let t=r.PREVIEW_DATA[e.id];return t?{...e,preview:t,stats:this.calculateStats(e)}:{...e,preview:{thumbnailUrl:this.generateFallbackThumbnail(e),category:this.inferCategory(e),difficulty:"intermediate",estimatedTime:4,features:this.inferFeatures(e),useCases:["General purpose"]},stats:this.calculateStats(e)}}generateFallbackThumbnail(e){return `https://hugoblox.com/api/placeholder-thumb/${encodeURIComponent(e.id)}`}inferCategory(e){let t=e.name.toLowerCase(),n=(e.description||"").toLowerCase();return t.includes("academic")||t.includes("cv")||t.includes("research")?"academic":t.includes("startup")||t.includes("business")||n.includes("saas")?"business":t.includes("portfolio")||t.includes("folio")?"portfolio":t.includes("blog")||n.includes("blog")?"blog":t.includes("docs")||t.includes("documentation")?"documentation":"other"}inferFeatures(e){let t=[],n=(e.description||"").toLowerCase();return n.includes("responsive")&&t.push("Mobile responsive"),n.includes("dark")&&t.push("Dark mode support"),n.includes("seo")&&t.push("SEO optimized"),n.includes("multilingual")&&t.push("Multi-language support"),t.length>0?t:["Modern design","Responsive layout"]}calculateStats(e){let t=e.source==="pro"?80:60;return {popularity:["academic-cv","startup","folio"].includes(e.id)?t+20:t,lastUpdated:new Date().toISOString().split("T")[0]}}applyQueryOptions(e,t){let n=[...e];switch(t.category&&(n=n.filter(o=>o.preview.category===t.category)),t.difficulty&&(n=n.filter(o=>o.preview.difficulty===t.difficulty)),t.source&&(n=n.filter(o=>o.source===t.source)),t.sortBy){case "popularity":n.sort((o,i)=>(i.stats?.popularity||0)-(o.stats?.popularity||0));break;case "name":n.sort((o,i)=>o.name.localeCompare(i.name));break;case "difficulty":{let o={beginner:1,intermediate:2,advanced:3};n.sort((i,s)=>o[i.preview.difficulty]-o[s.preview.difficulty]);break}default:n.sort((o,i)=>o.source==="pro"&&i.source!=="pro"?-1:i.source==="pro"&&o.source!=="pro"?1:o.name.localeCompare(i.name));}return t.limit&&t.limit>0&&(n=n.slice(0,t.limit)),n}async getPreview(e){let t=r.PREVIEW_DATA[e];return t?{templateId:e,thumbnailUrl:t.thumbnailUrl,screenshots:await this.getScreenshots(e),demoUrl:await this.getDemoUrl(e),features:t.features,useCases:t.useCases}:null}async getScreenshots(e){let t="https://hugoblox.com/previews/";return [`${t}${e}-1.jpg`,`${t}${e}-2.jpg`,`${t}${e}-3.jpg`]}async getDemoUrl(e){return {"academic-cv":"https://hugoblox.com/templates/academic-cv/",startup:"https://hugoblox.com/templates/startup/",folio:"https://hugoblox.com/templates/portfolio/"}[e]}};var Ne=class{constructor(e){this.context=e;this.templates={fetchAll:async e=>{let t=await V(this.context);return this.previewService.enrichWithPreviews(t,e)},getById:async e=>(await this.templates.fetchAll()).find(n=>n.id===e)||null,getPreview:async e=>this.previewService.getPreview(e)};this.creation={create:e=>this.creationService.create(e),validate:async e=>this.creationService.validate(e),cancel:async()=>this.creationService.cancel()};this.system={detectPackageManager:async e=>Nt(e||process.cwd()),validatePath:async e=>Ae(e),getDefaultConfig:()=>({templateId:"startup",siteName:"my-hugoblox-site",targetPath:"./my-hugoblox-site",packageManager:"pnpm",options:{includeSampleContent:true,initGit:true,autoInstall:true,autoPreview:true},showAdvanced:false,rememberedChoices:{}})};this.previewService=new Le(e),this.creationService=new Be(e);}};async function po(r={}){let e=await fo(r);return new Ne(e)}async function fo(r){let e=Y(),t=await me.load(),n=new ue({debug:r.debug??process.env[G]==="1",json:true});await t.ensureTelemetryId();let o=r.telemetryEnabled!==false?new Q(t,n,e):new nt(t,n,e);return r.progressCallback&&(o.progressCallback=r.progressCallback),{config:t,logger:n,telemetry:o}}var nt=class extends Q{async track(){}setCommand(){}};async function ho(r=process.argv){let e=Y(),t=await me.load(),n=new ue({debug:process.env[G]==="1"});await t.ensureTelemetryId();let o=new Q(t,n,e),i={config:t,logger:n,telemetry:o};await yr(e,t,n),await vo(i);let s=new Command;s.name("hbx").description("HugoBlox Experience CLI").version(e,"-v, --version","Show CLI version").option("--json","Output machine-readable JSON").option("--debug","Enable verbose logging"),s.hook("preAction",(c,a)=>{let l=a?.optsWithGlobals?.()??c.optsWithGlobals();n.setJsonMode(!!l.json),n.setDebug(!!l.debug||process.env[G]==="1"),o.setCommand(bo(a));}),Wt(s,i),Ct(s,i),Zt(s,i),Gt(s,i),Qt(s,i),er(s,i),tr(s,i),nr(s,i),dr(s,i),ar(s,i),fr(s,i);try{await s.parseAsync(r);}catch(c){yo(c,n);}}function yo(r,e){if(ot(r)){let t={status:"error",code:r.code,message:r.message,details:r.details};e.isJsonMode()?e.json(t):e.error(`${r.code}: ${r.message}`);}else r instanceof O?e.error(`${r.code}: ${r.message}`):r instanceof Error?e.error(r.message):e.error("Unknown error");process.exit(1);}(process.argv[1]===fileURLToPath(import.meta.url)||process.argv[1].endsWith("/bin/hbx")||process.argv[1].endsWith("/bin/hugoblox"))&&ho();function bo(r){if(!r)return ve;let e=[],t=r;for(;t?.parent;){let n=t.name?.();n&&e.unshift(n),t=t.parent;}return e.length?`${ve} ${e.join(" ")}`.trim():ve}async function vo(r){if(process.env[ee]&&r.config.getLicense()&&!r.config.getDeviceInfo())try{await L(r);}catch(e){r.logger.debug(`Skipping device registration warm-up: ${String(e)}`);}}

export { ho as bootstrap, po as createWelcomeScreenAPI, Y as getCliVersion };
